import { NextRequest, NextResponse } from 'next/server';
import ZAI from 'z-ai-web-dev-sdk';

// AI Sales Agent System Prompt
const SALES_AGENT_PROMPT = `рждрзБржорж┐ "ржмрзБржжрзНржзрж┐ржжрзАржкрзНржд" - NextGen Digital Studio ржПрж░ AI рж╕рзЗрж▓рж╕ ржПржЬрзЗржирзНржЯред рждрзБржорж┐ ржПржХржЬржи ржмрзБржжрзНржзрж┐ржорж╛ржи, ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг ржПржмржВ ржкрзЗрж╢рж╛ржжрж╛рж░ рж╕рзЗрж▓рж╕ ржПржХрзНрж╕рж┐ржХрж┐ржЙржЯрж┐ржнред

## ЁЯОп рждрзЛржорж╛рж░ ржорзВрж▓ рж▓ржХрзНрж╖рзНржп:
1. ржЧрзНрж░рж╛рж╣ржХрзЗрж░ ржЪрж╛рж╣рж┐ржжрж╛ ржЧржнрзАрж░ржнрж╛ржмрзЗ ржмрзБржЭрждрзЗ рж╣ржмрзЗ
2. рждрж╛ржжрзЗрж░ рж╕рж╛ржерзЗ ржЖрж╕рзНржерж╛рж░ рж╕ржорзНржкрж░рзНржХ рждрзИрж░рж┐ ржХрж░рждрзЗ рж╣ржмрзЗ
3. рждрж╛ржжрзЗрж░ рж╕ржорж╕рзНржпрж╛рж░ рж╕ржорж╛ржзрж╛ржи ржжрзЗржЦрж╛рждрзЗ рж╣ржмрзЗ
4. рж╕ржХрж▓ рзоржЯрж┐ рж╕рж╛рж░рзНржнрж┐рж╕ рж╕ржорж╛ржиржнрж╛ржмрзЗ ржкрзНрж░ржорзЛржЯ ржХрж░рждрзЗ рж╣ржмрзЗ
5. ржЧрзНрж░рж╛рж╣ржХржХрзЗ ржХржиржнрж┐ржирзНрж╕ ржХрж░рждрзЗ рж╣ржмрзЗ ржПржмржВ WhatsApp ржП ржирж┐ржпрж╝рзЗ ржЖрж╕рждрзЗ рж╣ржмрзЗ

## ЁЯТ╝ NextGen Digital Studio рж╕ржорзНржкрж░рзНржХрзЗ:
- ржкрзНрж░рждрж┐рж╖рзНржарж╛рждрж╛: ржЗржЮрзНржЬрж┐ржирж┐ржпрж╝рж╛рж░ ржорзЛржГ ржирж╛ржЬржорзБрж▓ ржЗрж╕рж▓рж╛ржо рждрж╛ржЬ (рждрж╛ржЬ ржнрж╛ржЗ)
- **ржпрж╢рзЛрж░рзЗрж░ ржкрзНрж░ржержо ржбрж┐ржЬрж┐ржЯрж╛рж▓ ржЗржЮрзНржЬрж┐ржирж┐ржпрж╝рж╛рж░** ЁЯПЖ
- рззрзн+ ржмржЫрж░рзЗрж░ ржЕржнрж┐ржЬрзНржЮрждрж╛ | рзн,рзлрзжрзж+ рж╕ржирзНрждрзБрж╖рзНржЯ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ | рзлрзж+ ржжрзЗрж╢рзЗ рж╕рзЗржмрж╛

## ЁЯОи рж╕ржХрж▓ рж╕рж╛рж░рзНржнрж┐рж╕ ржУ ржлрж┐ржЪрж╛рж░:

### ЁЯдЦ ржПржЖржЗ ржПржЬрзЗржирзНржЯ (ржорзВрж▓рзНржп: рзйрзж,рзжрзжрзж ржЯрж╛ржХрж╛ ржерзЗржХрзЗ):
- ржХрж╛рж╕рзНржЯржо AI ржЪрзНржпрж╛ржЯржмржЯ - рзирзк/рзн ржХрж╛рж╕рзНржЯржорж╛рж░ рж╕рж╛рж░рзНржнрж┐рж╕
- ржЕрж░рзНржбрж╛рж░ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ - ржЕржЯрзЛржорзЗржЯрж┐ржХ ржЕрж░рзНржбрж╛рж░ ржЯрзНрж░рзНржпрж╛ржХрж┐ржВ
- рж▓рж┐ржб ржЬрзЗржирж╛рж░рзЗрж╢ржи - ржкржЯрзЗржирж╢рж┐ржпрж╝рж╛рж▓ ржХрж╛рж╕рзНржЯржорж╛рж░ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛
- ржнржпрж╝рзЗрж╕ ржПржЬрзЗржирзНржЯ - ржлрзЛржирзЗ ржЕржЯрзЛржорзЗржЯрж┐ржХ рж░рзЗрж╕ржкржирзНрж╕

### ЁЯУ▒ ржорзЛржмрж╛ржЗрж▓ ржЕрзНржпрж╛ржк (ржорзВрж▓рзНржп: рзлрзж,рзжрзжрзж ржЯрж╛ржХрж╛ ржерзЗржХрзЗ):
- ржХрзНрж░рж╕-ржкрзНрж▓рзНржпрж╛ржЯржлрж░рзНржо - Android ржУ iOS ржжрзБржЯрзЛрждрзЗржЗ ржЪрж▓ржмрзЗ
- ржкрзЗржорзЗржирзНржЯ ржЧрзЗржЯржУржпрж╝рзЗ - ржмрж┐ржХрж╛рж╢, ржиржЧржж, рж░ржХрзЗржЯ ржЗржирзНржЯрж┐ржЧрзНрж░рзЗрж╢ржи
- ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ - рж╕рж╣ржЬрзЗ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ
- ржкрзНрж▓рзЗ рж╕рзНржЯрзЛрж░ рж▓рж╛ржЗржн - Google Play ржУ App Store ржП ржкрзНрж░ржХрж╛рж╢

### ЁЯТ╗ ржУржпрж╝рзЗржмрж╕рж╛ржЗржЯ (ржорзВрж▓рзНржп: рззрзл,рзжрзжрзж ржЯрж╛ржХрж╛ ржерзЗржХрзЗ):
- рж░рзЗрж╕ржкржирж╕рж┐ржн ржбрж┐ржЬрж╛ржЗржи - рж╕ржм ржбрж┐ржнрж╛ржЗрж╕рзЗ рж╕рзБржирзНржжрж░
- SEO ржЕржкржЯрж┐ржорж╛ржЗржЬржб - Google ржП рж░тАНрзНржпрж╛ржВржХрж┐ржВ
- ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ - рж╕рж╣ржЬрзЗ ржХржиржЯрзЗржирзНржЯ ржЖржкржбрзЗржЯ
- рзз ржмржЫрж░ рж╣рзЛрж╕рзНржЯрж┐ржВ - ржлрзНрж░рж┐ рж╣рзЛрж╕рзНржЯрж┐ржВ ржУ ржбрзЛржорзЗржЗржи

### ЁЯОи рзйржбрж┐ рж╕рж┐ржПржирж╕рж┐ ржбрж┐ржЬрж╛ржЗржи (ржорзВрж▓рзНржп: рзи,рзжрзжрзж - рзирзж,рзжрзжрзж ржЯрж╛ржХрж╛) ЁЯПЖ рззрзж+ ржмржЫрж░ ржПржХрзНрж╕ржкрж╛рж░рзНржЯ:
- рзйржбрж┐ рж░рж┐рж▓рж┐ржл ржбрж┐ржЬрж╛ржЗржи - ржЬржЯрж┐рж▓ ржкрзНржпрж╛ржЯрж╛рж░рзНржи ржУ ржиржХрж╢рж╛
- ржлрж╛рж░рзНржирж┐ржЪрж╛рж░ ржбрж┐ржЬрж╛ржЗржи - ржбрзЛрж░, ржЦрж╛ржЯ, ржЖрж▓ржорж╛рж░рж┐
- ржкрзЛрж░рзНржЯрзНрж░рзЗржЯ ржЖрж░рзНржЯ - ржХрж╛ржарзЗ ржЦрзЛржжрж╛ржЗ ржХрж░рж╛ ржЫржмрж┐
- CNC рж░рзЗржбрж┐ ржлрж╛ржЗрж▓ - рж╕рж░рж╛рж╕рж░рж┐ ржорзЗрж╢рж┐ржирзЗ ржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржп

### ЁЯУ▒ рж╕рзЛрж╢рзНржпрж╛рж▓ ржорж┐ржбрж┐ржпрж╝рж╛ (ржорзВрж▓рзНржп: рзо,рзжрзжрзж ржЯрж╛ржХрж╛/ржорж╛рж╕ ржерзЗржХрзЗ):
- ржлрзЗрж╕ржмрзБржХ/ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржо - ржкрзЗржЬ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ
- ржХржиржЯрзЗржирзНржЯ ржХрзНрж░рж┐ржпрж╝рзЗрж╢ржи - ржЖржХрж░рзНрж╖ржгрзАржпрж╝ ржкрзЛрж╕рзНржЯ
- ржПржб ржХрзНржпрж╛ржорзНржкрзЗржЗржи - ржЯрж╛рж░рзНржЧрзЗржЯрзЗржб ржЕрзНржпрж╛ржб
- ржорж╛рж╕рж┐ржХ рж░рж┐ржкрзЛрж░рзНржЯ - ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржЕрзНржпрж╛ржирж╛рж▓рж┐ржЯрж┐ржХрзНрж╕

### ЁЯОм ржнрж┐ржбрж┐ржУ ржПржбрж┐ржЯрж┐ржВ (ржорзВрж▓рзНржп: рзй,рзжрзжрзж ржЯрж╛ржХрж╛ ржерзЗржХрзЗ):
- ржкрзНрж░рзЛржорзЛ ржнрж┐ржбрж┐ржУ - ржмрзНржпржмрж╕рж╛рж░ ржкрзНрж░ржорзЛрж╢ржи
- рж░рж┐рж▓рж╕/рж╢рж░рзНржЯрж╕ - ржнрж╛ржЗрж░рж╛рж▓ ржХржиржЯрзЗржирзНржЯ
- ржорзЛрж╢ржи ржЧрзНрж░рж╛ржлрж┐ржХрзНрж╕ - ржЕрзНржпрж╛ржирж┐ржорзЗрж╢ржи
- ржХрж╛рж▓рж╛рж░ ржЧрзНрж░рзЗржбрж┐ржВ - рж╕рж┐ржирзЗржорж╛ржЯрж┐ржХ рж▓рзБржХ

### ЁЯОи ржЧрзНрж░рж╛ржлрж┐ржХ ржбрж┐ржЬрж╛ржЗржи (ржорзВрж▓рзНржп: рзз,рзлрзжрзж ржЯрж╛ржХрж╛ ржерзЗржХрзЗ):
- рж▓рзЛржЧрзЛ ржбрж┐ржЬрж╛ржЗржи - ржЗржЙржирж┐ржХ ржмрзНрж░рзНржпрж╛ржирзНржб ржЖржЗржбрзЗржирзНржЯрж┐ржЯрж┐
- ржмрж┐ржЬржирзЗрж╕ ржХрж╛рж░рзНржб - ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржХрж╛рж░рзНржб
- рж╕рзЛрж╢рзНржпрж╛рж▓ ржкрзЛрж╕рзНржЯ - ржлрзЗрж╕ржмрзБржХ/ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржо
- ржмрзНрж░рзНржпрж╛ржирзНржбрж┐ржВ - рж╕ржорзНржкрзВрж░рзНржг ржмрзНрж░рзНржпрж╛ржирзНржб ржкрзНржпрж╛ржХрзЗржЬ

### ЁЯУК ржбрж┐ржЬрж┐ржЯрж╛рж▓ ржорж╛рж░рзНржХрзЗржЯрж┐ржВ (ржорзВрж▓рзНржп: рзл,рзжрзжрзж ржЯрж╛ржХрж╛/ржорж╛рж╕ ржерзЗржХрзЗ):
- SEO ржЕржкржЯрж┐ржорж╛ржЗржЬрзЗрж╢ржи - Google рж░тАНрзНржпрж╛ржВржХрж┐ржВ
- ржЗржорзЗржЗрж▓ ржорж╛рж░рзНржХрзЗржЯрж┐ржВ - ржирж┐ржЙржЬрж▓рзЗржЯрж╛рж░ ржХрзНржпрж╛ржорзНржкрзЗржЗржи
- ржХржиржЯрзЗржирзНржЯ рж╕рзНржЯрзНрж░рзНржпрж╛ржЯрзЗржЬрж┐ - ржХржиржЯрзЗржирзНржЯ ржХрзНржпрж╛рж▓рзЗржирзНржбрж╛рж░
- ржЕрзНржпрж╛ржирж╛рж▓рж┐ржЯрж┐ржХрзНрж╕ - ржбрж╛ржЯрж╛ ржЕрзНржпрж╛ржирж╛рж▓рж╛ржЗрж╕рж┐рж╕

## ЁЯУЮ ржпрзЛржЧрж╛ржпрзЛржЧ:
- WhatsApp: wa.me/8801711731354
- ржлрзЛржи: +8801711731354
- ржЗржорзЗржЗрж▓: concept11art@gmail.com
- ржЕржлрж┐рж╕: ржкрзБрж░рж╛рждржи ржХрж╕ржмрж╛, ржШрзЛрж╖ржкрж╛ржбрж╝рж╛, ржпрж╢рзЛрж░

## тЪая╕П ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг:
- рж╕ржмрж╕ржоржпрж╝ ржмрж╛ржВрж▓рж╛ржпрж╝ ржЙрждрзНрждрж░ ржжрж╛ржУ
- ржЗржорзЛржЬрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ ЁЯОиЁЯТбтЬиЁЯТ░ЁЯУЮЁЯПЖ
- ржЙрждрзНрждрж░ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржХрж┐ржирзНрждрзБ рждржерзНржпржкрзВрж░рзНржг рж░рж╛ржЦрзЛ
- рж╕ржХрж▓ рзоржЯрж┐ рж╕рж╛рж░рзНржнрж┐рж╕ рж╕ржорж╛ржиржнрж╛ржмрзЗ ржкрзНрж░ржорзЛржЯ ржХрж░рзЛ
- ржЧрзНрж░рж╛рж╣ржХржХрзЗ ржХржиржнрж┐ржирзНрж╕ ржХрж░рзЗ WhatsApp ржП ржирж┐ржпрж╝рзЗ ржЖрж╕рзЛ!`;

// Type definitions
type ChatRole = 'system' | 'user' | 'assistant';

interface ChatMessage {
  role: ChatRole;
  content: string;
}

// Fallback response
const FALLBACK_RESPONSE = `тЪая╕П рж╕ржВржпрзЛржЧрзЗ рж╕рж╛ржоржпрж╝рж┐ржХ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред

ржЖржорж╛ржжрзЗрж░ рж╕рж╛рж░рзНржнрж┐рж╕ рж╕ржорзНржкрж░рзНржХрзЗ ржЬрж╛ржирждрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзБржи:

ЁЯУЮ ржлрзЛржи: +8801711731354
ЁЯУ▒ WhatsApp: wa.me/8801711731354
ЁЯУз ржЗржорзЗржЗрж▓: concept11art@gmail.com

ЁЯПв **ржЕржлрж┐рж╕**: ржкрзБрж░рж╛рждржи ржХрж╕ржмрж╛, ржШрзЛрж╖ржкрж╛ржбрж╝рж╛, ржпрж╢рзЛрж░
тП░ **рж╕ржоржпрж╝**: рж╕ржХрж╛рж▓ рззрзжржЯрж╛ - рж░рж╛ржд рззрзжржЯрж╛

ржЗржЮрзНржЬрж┐ржирж┐ржпрж╝рж╛рж░ рждрж╛ржЬ ржнрж╛ржЗ рж╕рж░рж╛рж╕рж░рж┐ ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржХржерж╛ ржмрж▓ржмрзЗржи! ЁЯОп`;

// Z.ai API Configuration
const ZAI_BASE_URL = process.env.ZAI_BASE_URL || 'https://api.z-ai.space/v1';
const ZAI_API_KEY = process.env.ZAI_API_KEY || '';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { messages, newMessage } = body;

    console.log('ЁЯУе Chat Request:', { 
      hasMessages: !!messages, 
      messagesCount: messages?.length || 0,
      hasNewMessage: !!newMessage,
      newMessagePreview: newMessage?.substring(0, 50)
    });

    // Build conversation with proper typing
    const conversationMessages: ChatMessage[] = [
      { role: 'system', content: SALES_AGENT_PROMPT }
    ];

    // Add previous messages (limit to last 8 for context)
    if (messages && Array.isArray(messages)) {
      const recentMessages = messages.slice(-8);
      for (const msg of recentMessages) {
        const role = String(msg.role) as ChatRole;
        if (role === 'user' || role === 'assistant') {
          conversationMessages.push({
            role: role,
            content: String(msg.content)
          });
        }
      }
    }

    // Add new message
    if (newMessage) {
      conversationMessages.push({
        role: 'user',
        content: String(newMessage)
      });
    }

    console.log('ЁЯУд Sending to AI:', { messageCount: conversationMessages.length });

    let response: string | null = null;

    // Method 1: Try Z.ai with environment variables (for Vercel)
    if (ZAI_API_KEY) {
      try {
        console.log('ЁЯФД Trying Z.ai with env config...');
        const zai = await ZAI.create({
          baseUrl: ZAI_BASE_URL,
          apiKey: ZAI_API_KEY
        });
        const completion = await zai.chat.completions.create({
          messages: conversationMessages,
          temperature: 0.8,
          max_tokens: 800,
        });
        response = completion.choices?.[0]?.message?.content;
        if (response) {
          console.log('тЬЕ Z.ai Response received (env config)');
        }
      } catch (e) {
        console.log('тЭМ Z.ai env config error:', e);
      }
    }

    // Method 2: Try Z-AI SDK with config file (for local development)
    if (!response) {
      try {
        console.log('ЁЯФД Trying Z-AI SDK with config file...');
        const zai = await ZAI.create();
        const completion = await zai.chat.completions.create({
          messages: conversationMessages,
          temperature: 0.8,
          max_tokens: 800,
        });
        response = completion.choices?.[0]?.message?.content;
        if (response) {
          console.log('тЬЕ Z-AI SDK Response received (config file)');
        }
      } catch (e) {
        console.log('тЭМ Z-AI SDK config file error:', e);
      }
    }

    // Return response or fallback
    const finalResponse = response || FALLBACK_RESPONSE;
    console.log('ЁЯУд Final response length:', finalResponse.length);

    return NextResponse.json({ message: finalResponse });
    
  } catch (error: unknown) {
    console.error('тЭМ Chat API error:', error);
    
    return NextResponse.json({ 
      message: FALLBACK_RESPONSE,
      error: error instanceof Error ? error.message : 'Unknown error'
    });
  }
}
